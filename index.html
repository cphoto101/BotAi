<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #ffffff;
            --card-bg: #1e1e1e;
            --accent: #0088cc;
            --btn-text: #ffffff;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color); color: var(--text-color);
            font-family: -apple-system, sans-serif;
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }

        .loader {
            border: 4px solid #333; border-top: 4px solid var(--accent);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .container { padding: 15px; max-width: 600px; margin: auto; }

        /* Admin UI */
        #adminSection { display: none; margin-bottom: 20px; }
        .admin-card {
            background: var(--card-bg); padding: 15px; border-radius: 12px;
            border: 1px solid var(--accent); box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* Tabs */
        .tabs {
            display: flex; background: var(--card-bg); border-radius: 10px;
            padding: 4px; margin-bottom: 20px;
        }
        .tab {
            flex: 1; text-align: center; padding: 12px; border-radius: 8px;
            cursor: pointer; transition: 0.3s;
        }
        .tab.active { background: var(--accent); color: var(--btn-text); font-weight: bold; }

        /* Form Inputs */
        input, textarea, select {
            width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px;
            border: 1px solid #333; background: #252525; color: white; box-sizing: border-box;
        }
        button {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            background: var(--accent); color: white; font-weight: bold; cursor: pointer;
        }

        /* Content Cards */
        .card {
            background: var(--card-bg); border-radius: 12px; margin-bottom: 15px;
            display: flex; overflow: hidden; gap: 12px;
        }
        .poster { width: 100px; height: 140px; object-fit: cover; }
        .info { padding: 10px; flex: 1; }
        .music-card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        audio { width: 100%; margin-top: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="loadingScreen">
        <div class="loader"></div>
        <h3 id="userNameDisplay" style="margin-top:15px;">Welcome</h3>
    </div>

    <div class="container" id="mainApp" style="display:none;">
        
        <div id="adminSection">
            <div id="loginForm" class="admin-card">
                <h4>ðŸ”’ Admin Login</h4>
                <input type="email" id="email" placeholder="Email">
                <input type="password" id="pass" placeholder="Password">
                <button onclick="adminLogin()">Login</button>
            </div>

            <div id="uploadForm" class="admin-card hidden">
                <div style="display:flex; justify-content:space-between;">
                    <h4>ðŸ“¤ Upload</h4>
                    <button onclick="logout()" style="width:auto; padding:4px 10px; background:#ff4757;">Logout</button>
                </div>
                <select id="type" onchange="toggleInputs()">
                    <option value="movie">Movie</option>
                    <option value="music">Music</option>
                </select>

                <div id="movieInp">
                    <input type="text" id="mTitle" placeholder="Title">
                    <textarea id="mReview" placeholder="Review"></textarea>
                    <input type="text" id="mKey" placeholder="Secret Key">
                    <input type="file" id="mFile" accept="image/*">
                </div>

                <div id="musicInp" class="hidden">
                    <input type="text" id="muTitle" placeholder="Song Title">
                    <textarea id="muLyrics" placeholder="Lyrics"></textarea>
                    <input type="file" id="muFile" accept="audio/*">
                </div>

                <button id="upBtn" onclick="uploadData()">Upload Now</button>
                <p id="progress" style="font-size: 12px; text-align: center; color: var(--accent);"></p>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('movie')">Movies</div>
            <div class="tab" onclick="switchTab('music')">Music</div>
        </div>

        <div id="movieDisplay"></div>
        <div id="musicDisplay" class="hidden"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // Your Config
        const firebaseConfig = {
            apiKey: "AIzaSyCdyEiklUPrEL6TklIDyOh_F-PhgCyCjLw",
            authDomain: "zzaro0.firebaseapp.com",
            projectId: "zzaro0",
            storageBucket: "zzaro0.firebasestorage.app",
            messagingSenderId: "197891222875",
            appId: "1:197891222875:web:8897ba4de2829eeb0d3e7e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const tg = window.Telegram.WebApp;
        tg.expand();

        // âš ï¸ Change this to your Telegram ID
        const MY_ADMIN_ID = 1924452453; 

        // Initial Load
        window.addEventListener('load', () => {
            const user = tg.initDataUnsafe.user;
            if(user) document.getElementById('userNameDisplay').innerText = `Hello, ${user.first_name}!`;
            
            if(user && user.id === MY_ADMIN_ID) {
                document.getElementById('adminSection').style.display = 'block';
            }

            setTimeout(() => {
                document.getElementById('loadingScreen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                }, 500);
            }, 2000);
        });

        // Auth Functions
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('uploadForm').classList.remove('hidden');
            } else {
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('uploadForm').classList.add('hidden');
            }
        });

        window.adminLogin = async () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('pass').value;
            try { await signInWithEmailAndPassword(auth, e, p); } 
            catch (err) { alert("Error: " + err.message); }
        };

        window.logout = () => signOut(auth);

        // UI Logic
        window.switchTab = (t) => {
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            if(t === 'movie') {
                document.getElementById('movieDisplay').classList.remove('hidden');
                document.getElementById('musicDisplay').classList.add('hidden');
            } else {
                document.getElementById('movieDisplay').classList.add('hidden');
                document.getElementById('musicDisplay').classList.remove('hidden');
            }
        };

        window.toggleInputs = () => {
            const type = document.getElementById('type').value;
            document.getElementById('movieInp').classList.toggle('hidden', type !== 'movie');
            document.getElementById('musicInp').classList.toggle('hidden', type !== 'music');
        };

        // Upload Data
        window.uploadData = async () => {
            const type = document.getElementById('type').value;
            const btn = document.getElementById('upBtn');
            const progress = document.getElementById('progress');
            
            btn.disabled = true;
            progress.innerText = "Uploading... please wait.";

            try {
                if(type === 'movie') {
                    const file = document.getElementById('mFile').files[0];
                    if(!file) throw new Error("Select Image");
                    const sRef = ref(storage, `movies/${Date.now()}_${file.name}`);
                    await uploadBytes(sRef, file);
                    const url = await getDownloadURL(sRef);

                    await addDoc(collection(db, "movies"), {
                        title: document.getElementById('mTitle').value,
                        review: document.getElementById('mReview').value,
                        key: document.getElementById('mKey').value,
                        img: url,
                        time: Date.now()
                    });
                } else {
                    const file = document.getElementById('muFile').files[0];
                    if(!file) throw new Error("Select Audio");
                    const sRef = ref(storage, `music/${Date.now()}_${file.name}`);
                    await uploadBytes(sRef, file);
                    const url = await getDownloadURL(sRef);

                    await addDoc(collection(db, "music"), {
                        title: document.getElementById('muTitle').value,
                        lyrics: document.getElementById('muLyrics').value,
                        audio: url,
                        time: Date.now()
                    });
                }
                alert("Success!");
                progress.innerText = "";
            } catch (err) { alert(err.message); progress.innerText = ""; }
            btn.disabled = false;
        };

        // Fetch Data
        onSnapshot(query(collection(db, "movies"), orderBy("time", "desc")), (snap) => {
            const div = document.getElementById('movieDisplay');
            div.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                div.innerHTML += `<div class="card">
                    <img src="${d.img}" class="poster">
                    <div class="info">
                        <h3 style="margin:0;">${d.title}</h3>
                        <p style="font-size:12px; color:var(--accent);">Key: ${d.key}</p>
                        <p style="font-size:13px; color:#aaa;">${d.review}</p>
                    </div>
                </div>`;
            });
        });

        onSnapshot(query(collection(db, "music"), orderBy("time", "desc")), (snap) => {
            const div = document.getElementById('musicDisplay');
            div.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                div.innerHTML += `<div class="music-card">
                    <h3 style="margin:0;">ðŸŽµ ${d.title}</h3>
                    <audio controls src="${d.audio}"></audio>
                    <p style="font-size:13px; color:#aaa; white-space:pre-line; margin-top:10px;">${d.lyrics}</p>
                </div>`;
            });
        });
    </script>
</body>
</html>
